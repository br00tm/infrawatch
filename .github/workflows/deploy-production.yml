name: Deploy to Production

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

concurrency:
  group: production-deploy
  cancel-in-progress: false   # Never cancel a prod deploy

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://infrawatch.example.com

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "TAG=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Deploying tag: ${TAG}"

      - name: Install kubectl & Helm
        run: |
          curl -sfL https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure kubeconfig
        run: |
          mkdir -p "$HOME/.kube"
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: Update Helm chart dependencies
        run: helm dependency update charts/infrawatch/

      - name: Deploy with Helm (atomic)
        env:
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
        run: |
          helm upgrade --install infrawatch charts/infrawatch/ \
            --namespace infrawatch \
            --create-namespace \
            --values charts/infrawatch/values.yaml \
            --values charts/infrawatch/values-prod.yaml \
            --set "backend.image.repository=ghcr.io/${{ github.repository }}/backend" \
            --set "backend.image.tag=${{ steps.tag.outputs.TAG }}" \
            --set "frontend.image.repository=ghcr.io/${{ github.repository }}/frontend" \
            --set "frontend.image.tag=${{ steps.tag.outputs.TAG }}" \
            --set "worker.image.repository=ghcr.io/${{ github.repository }}/workers" \
            --set "worker.image.tag=${{ steps.tag.outputs.TAG }}" \
            --set "mongodb.auth.rootPassword=${MONGODB_PASSWORD}" \
            --set "mongodb.auth.password=${MONGODB_PASSWORD}" \
            --set "rabbitmq.auth.password=${RABBITMQ_PASSWORD}" \
            --set "backend.secrets.jwtSecretKey=${JWT_SECRET_KEY}" \
            --timeout 15m \
            --wait \
            --atomic \
            --cleanup-on-fail

      - name: Production smoke test
        run: |
          sleep 10
          curl -sf https://infrawatch.example.com/api/v1/health/ping || exit 1
          echo "Production smoke test passed"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          tag_name: ${{ steps.tag.outputs.TAG }}

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production deployment failed: ${context.ref}`,
              body: `Deployment of ${context.sha} failed. See run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'production']
            })
