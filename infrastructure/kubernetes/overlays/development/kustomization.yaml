apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Note: ../../base (Namespaces, NetworkPolicies, ResourceQuotas) is applied
# separately by the deploy script to avoid the kustomize namespace transformer
# incorrectly renaming Namespace resources themselves.
resources:
  - ../../apps/backend
  - ../../apps/frontend
  - ../../apps/workers

namespace: infrawatch

# Development-specific image tags (pointing to local registry)
images:
  - name: infrawatch/backend
    newName: localhost:5000/infrawatch/backend
    newTag: develop
  - name: infrawatch/frontend
    newName: localhost:5000/infrawatch/frontend
    newTag: develop
  - name: infrawatch/workers
    newName: localhost:5000/infrawatch/workers
    newTag: develop

# All patches in a single block
patches:
  # Scale down to 1 replica for dev
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: backend
        namespace: infrawatch
      spec:
        replicas: 1
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: frontend
        namespace: infrawatch
      spec:
        replicas: 1
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: worker
        namespace: infrawatch
      spec:
        replicas: 1

  # Reduce HPA minReplicas to 1 in dev so it doesn't override the replica count above
  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: backend-hpa
        namespace: infrawatch
      spec:
        minReplicas: 1
        maxReplicas: 2

  # Development env overrides
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: backend-config
        namespace: infrawatch
      data:
        APP_ENV: "development"
        DEBUG: "true"
        CORS_ORIGINS: '["http://localhost:3000","http://localhost:5173"]'
