# Promtail Helm values
# helm install promtail grafana/promtail -n infrawatch-monitoring -f promtail-config.yaml

config:
  logLevel: info
  serverPort: 3101

  clients:
    - url: http://loki.infrawatch-monitoring.svc.cluster.local:3100/loki/api/v1/push

  snippets:
    pipelineStages:
      # JSON parsing for structured logs
      - match:
          selector: '{namespace=~"infrawatch.*"}'
          stages:
            - json:
                expressions:
                  level: level
                  message: message
                  logger: logger
                  timestamp: timestamp
            - labels:
                level:
                logger:
            - timestamp:
                source: timestamp
                format: RFC3339Nano

      # Parse nginx access logs from frontend
      - match:
          selector: '{app="frontend"}'
          stages:
            - regex:
                expression: >-
                  ^(?P<remote_addr>[\d.]+) - (?P<remote_user>\S+) \[(?P<time_local>.+)\] "(?P<method>\S+) (?P<request>\S+) \S+" (?P<status>\d+) (?P<body_bytes_sent>\d+)
            - labels:
                method:
                status:

    # Scrape all pods in infrawatch namespaces
    scrapeConfigs: |
      - job_name: kubernetes-pods-infrawatch
        pipeline_stages:
          - cri: {}
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - infrawatch
                - infrawatch-data
                - infrawatch-monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_controller_name]
            regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
            action: replace
            target_label: __tmp_controller_name
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name, __tmp_controller_name, __meta_kubernetes_pod_name]
            regex: ^;*([^;]+)(;.*)?$
            action: replace
            target_label: app
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: replace
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: replace
            target_label: container
          - replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
          - action: replace
            replacement: /var/log/pods/*$1/*.log
            regex: true/(.*)
            separator: /
            source_labels: [__meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash, __meta_kubernetes_pod_annotation_kubernetes_io_config_hash, __meta_kubernetes_pod_container_name]
            target_label: __path__

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 256Mi

tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
